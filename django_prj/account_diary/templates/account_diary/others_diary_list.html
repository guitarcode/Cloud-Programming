<!-- expense_list.html -->
{% extends 'blog/base.html' %}

{% block main_area %}

    <form id="filter-form" class="form-inline mb-3">
        <div class="form-group">
            <label for="city" class="mr-2">City:</label>
            <select name="city" id="city" class="form-control mr-2">
                <option value="">All</option>
                {% for city in cities %}
                    <option value="{{ city.id }}"
                            {% if selected_city_id == city.id %}selected{% endif %}>{{ city.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="country" class="mr-2">Country:</label>
            <select name="country" id="country" class="form-control mr-2">
                <option value="">All</option>
                {% for country in countries %}
                    <option value="{{ country.id }}"
                            {% if selected_country_id == country.id %}selected{% endif %}>{{ country.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="industry" class="mr-2">Industry:</label>
            <select name="industry" id="industry" class="form-control mr-2">
                <option value="">All</option>
                {% for industry in industries %}
                    <option value="{{ industry.id }}"
                            {% if selected_industry_id == industry.id %}selected{% endif %}>{{ industry.name }}</option>
                {% endfor %}
            </select>
        </div>

        <button type="submit" class="btn btn-primary mr-2">검색</button>
        {% if user.is_authenticated %}
        <div class="row">
            <div class="col">
            </div>
        </div>
        {% endif %}
    </form>

    <div class="container">
        <div class="row">
            <div class="col-md-8 col-lg-9 mx-auto">
                <table class="table">
                    <thead>
                    <tr>
                        <th>제목</th>
                        <th>금액</th>
                        <th>도시</th>
                        <th>시군구</th>
                        <th>분류</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for expense in expenses %}
                        <tr>
                            <td>{{ expense.title }}</td>
                            <td>{{ expense.amount }}원</td>
                            <td>{{ expense.store.city.name }}</td>
                            <td>{{ expense.store.country.name }}</td>
                            <td>{{ expense.store.industry.name }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="5">해당 활동이 존재하지 않습니다.</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>

                <div id="pagination" class="text-center">
                    <!-- 페이지 이동을 위한 버튼 -->
                    {% if expenses.has_previous %}
                        <a href="?{% if selected_city_id %}city={{ selected_city_id }}&{% endif %}{% if selected_country_id %}country={{ selected_country_id }}&{% endif %}{% if selected_industry_id %}industry={{ selected_industry_id }}&{% endif %}page={{ expenses.previous_page_number }}">Previous</a>
                    {% endif %}

                    <span>{{ expenses.number }}</span>

                    {% if expenses.has_next %}
                        <a href="?{% if selected_city_id %}city={{ selected_city_id }}&{% endif %}{% if selected_country_id %}country={{ selected_country_id }}&{% endif %}{% if selected_industry_id %}industry={{ selected_industry_id }}&{% endif %}page={{ expenses.next_page_number }}">Next</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
        // 필터링 폼 제출 시 queryString 유지 및 페이지 이동 처리
        document.getElementById('filter-form').addEventListener('submit', function (event) {
            event.preventDefault();
            const formData = new FormData(this);
            const queryString = new URLSearchParams(formData).toString();
            const url = window.location.pathname + '?' + queryString;
            window.location.href = url;
        });

        // 페이지 이동 시 queryString 유지


        // 드롭다운 필드의 default 값 설정
        const urlParams = new URLSearchParams(window.location.search);
        const defaultCityId = urlParams.get('city');
        const defaultCountryId = urlParams.get('country');
        const defaultIndustryId = urlParams.get('industry');

        document.getElementById('city').value = defaultCityId || '';
        document.getElementById('country').value = defaultCountryId || '';
        document.getElementById('industry').value = defaultIndustryId || '';
    </script>
{% endblock %}
